XIAOMI.namespace("goodsDetail"),XIAOMI.goodsDetail={init:function(){var _this=this;_this.picShow(),_this.faqModal(),_this.pageScroll(),$(window).scroll(function(){var sT=$(this).scrollTop(),goodsDetailTop=$("#goodsDetail").offset().top+50;if(sT>goodsDetailTop){$("#goodsSubBar").addClass("goods-sub-bar-play"),$("#goodsSubMenu").find("li").eq(0).addClass("current").siblings().removeClass("current");var lens=$("#goodsSubMenu > ul > li:gt(0)").length;$("#goodsSubMenu > ul > li:gt(0)").each(function(){var id=$(this).find("a").attr("href"),itemSt=$(id).offset().top-70,nextItem=null;nextItem=lens>$(this).index()?$(this).next().find("a").attr("href"):$(".footer"),nextItemSt=$(nextItem).offset().top,sT>itemSt&&nextItemSt>sT&&$(this).addClass("current").siblings().removeClass("current")})}else $("#goodsSubBar").removeClass("goods-sub-bar-play")}),_this.getHistory(),XIAOMI.app.googleAnalytics([".mayBeLike","#historyBox"],{page:"单品页",position:["A","B"],url:!0}),XIAOMI.app.googleAnalytics(["#goddsDescMenu","#goodsSubMenu"],{page:"单品页",position:["B","B"],url:!1}),_this.createHistory();var userId=XIAOMI.app.cookie("userId");userId&&_this.goodsCollect(XIAOMI.GLOBAL_CONFIG.orderSite+"/favorite/check/id/"),$("#goodsDetailCollectBtn").click(function(){var isFavorite=$(this).attr("data-isfavorite");return _gaq.push(["_trackEvent","单品页","A1","收藏"]),"true"===isFavorite?_this.goodsCollect(XIAOMI.GLOBAL_CONFIG.orderSite+"/favorite/drop/id/","del"):_this.goodsCollect(XIAOMI.GLOBAL_CONFIG.orderSite+"/favorite/add/id/","add"),!1}),XIAOMI.app.addShopCartEvent({obj:"#goodsDetailAddCartBtn",callback:function(data,obj){if(obj.attr("data-disabled","false"),_gaq.push(["_trackEvent","单品页","A1","加入购物车"]),1===data.code){var flyDom=$("<img>"),flyT=obj.offset().top-166,flyL=obj.offset().left,targetT=$("#miniCart").offset().top+20,targetL=$("#miniCart").offset().left+60,picSrc=$("#goodsPicList").find("li").eq(0).find("img").attr("src");flyDom.css({display:"block",width:"160px",height:"160px",position:"absolute",top:flyT,left:flyL,"z-index":"1000",border:"2px solid #f60"}).attr("src",picSrc),flyDom.appendTo("body").animate({top:targetT,left:targetL,width:"20px",height:"20px"},400,"linear",function(){$(this).remove()})}else alert(data.message)}}),XIAOMI.app.addShopCartEvent({obj:"#goodsSubBarAddCartBtn",callback:function(data,obj){if(obj.attr("data-disabled","false"),_gaq.push(["_trackEvent","单品页","A1","加入购物车-下"]),1===data.code){obj.parent().css({position:"relative",overflow:"hidden"});var tipDom=$("<span>");tipDom.html("<i class='icon-goods-add-success'></i>加入成功！").appendTo(obj.parent()).addClass("item-action-state").animate({top:"10px"},200,function(){var $this=$(this);setTimeout(function(){$this.animate({top:"50px"},200,function(){$(this).remove()})},1e3)})}else alert(data.message)}}),$("#goodsCommentTrigger").click(function(){return XIAOMI.productComment.init({gid:goodsConfig.GoodsId,gname:goodsConfig.GoodsName,pic:goodsConfig.GoodsCommentPic}),!1}),$("#goodsOnlineTrigger").click(function(){return _this.onlineService(),!1})},picShow:function(){var list=$("#goodsPicList"),items=list.children(),lens=items.length,btnPrev=$("#goodsPicPrev"),btnNext=$("#goodsPicNext"),bigPic=$("#goodsBigPic"),currIndex=0,play=null;btnPrev.height(btnPrev.parent().height()),btnNext.height(btnNext.parent().height()),2>lens&&(btnPrev.hide(),btnNext.hide(),list.hide()),items.each(function(){0===$(this).index()&&$(this).addClass("current"),$(this).click(function(){var i=$(this).index();$(this).children("img").attr("data-src"),currIndex=i,play(currIndex)})}),btnNext.click(function(){currIndex+=1,(currIndex>=lens||0>currIndex)&&(currIndex=0),play(currIndex)}),btnPrev.click(function(){currIndex-=1,currIndex>=lens?currIndex=0:0>currIndex&&(currIndex=lens-1),play(currIndex)}),play=function(i){var dataSrc=items.eq(i).children("img").attr("data-src");dataSrc&&bigPic.attr("src",dataSrc),items.eq(currIndex).addClass("current").siblings().removeClass("current")}},pageScroll:function(){var subMenu=$("#goodsSubMenu > ul > li"),descMenu=$("#goddsDescMenu > ul > li"),scrollFun=null;descMenu.each(function(){$(this).index(),$(this).find("a").click(function(){var anchor=$(this).attr("href");return scrollFun($(anchor)),!1})}),subMenu.each(function(){$(this).find("a").click(function(){var anchor=$(this).attr("href");return"#"===anchor?scrollFun($(".header")):scrollFun($(anchor)),$(this).parent().addClass("current").siblings().removeClass("current"),!1})}),$("#goodsToComment").click(function(){return scrollFun($($(this).attr("href"))),!1}),scrollFun=function(obj){if("object"!=typeof obj)return!1;var oT=obj.offset().top-60;$("html,body").animate({scrollTop:oT+"px"},500)}},getHistory:function(){var historyList=XIAOMI.app.History();historyList&&$("#historyBox").show().find(".bd").html(historyList)},createHistory:function(){var pic=$("#goodsPicList > li").eq(0).find("img").attr("src"),name=$("#goodsName").html(),price=$("#goodsPrice").html(),gid=goodsConfig.GoodsId,cookieString=pic+","+name+","+price+","+gid,historyVal=XIAOMI.app.cookie("xm_goods_history");if(historyVal){var historyArray=historyVal.split(";"),repeatIndex=$.inArray(cookieString,historyArray);repeatIndex>-1&&historyArray.splice(repeatIndex,1),historyArray.length>6&&historyArray.pop(),historyVal=cookieString+";"+historyArray.join(";")}else historyVal=cookieString+";";XIAOMI.app.cookie("xm_goods_history",historyVal,{path:"/",domain:"."})},goodsCollect:function(url,type){var _this=this,getUrl=url+goodsConfig.GoodsId;$.ajax({type:"GET",url:getUrl,dataType:"jsonp",jsonp:"jsonpcallback",success:function(data){if(1===data.code){$("#goodsDetailCollectBtn").attr("data-isfavorite","true").find(".icon-common").addClass("icon-common-heart");var top=$("#goodsDetailCollectBtn").find(".icon-common").offset().top,left=$("#goodsDetailCollectBtn").find(".icon-common").offset().left;"add"===type?($("body").append("<img  src='http://p.www./zt/2013/icon-big-heart.png' id='playHeart'>"),$("#playHeart").css({top:top-5,left:left-5}).animate({width:"13px",height:"13px",top:top,left:left},300,function(){$(this).remove()})):"del"===type&&($("#goodsDetailCollectBtn").attr("data-isfavorite","false").find(".icon-common").removeClass("icon-common-heart"),$("body").append("<img  src='http://p.www./zt/2013/icon-big-grayheart.png' id='playHeart'>"),$("#playHeart").css({top:top-5,left:left-5}).animate({width:"13px",height:"13px",top:top,left:left},300,function(){$(this).remove()}))}else if(-1===data.code)alert(data.message);else if(-2===data.code)if(XIAOMI.app.cookie("userId")){var iframesrc=XIAOMI.GLOBAL_CONFIG.orderSite+"/user/proxy/stop/1",iframebody="<iframe src='"+iframesrc+"' width='0' height='0' name='proxy' id='proxy' frameborder='0' scrolling='no'></iframe>";$(document.body).append(iframebody),$("iframe[name='proxy']").load(function(){$("iframe[name='proxy']").remove(),_this.goodsCollect(url,type)})}else{var oLogin=new XIAOMI.app.miniLogin;oLogin.autoExec()}}})},onlineService:function(){var tmp="width=800px,height=580px,toolbar=no,status=no,location=no";window.open("http://chat.kefu.","kefu",tmp)},faqModal:function(){var util={getUnitAllHeight:function(pa){var hashIndex=[];return pa.each(function(){var height=$(this).offset().top;hashIndex.push(height)}),hashIndex}},isIE=!!window.ActiveXObject,isIE6=isIE&&!window.XMLHttpRequest,isIE8=isIE&&!!document.documentMode,isIE7=isIE&&!isIE6&&!isIE8;$("#serQue").click(function(){if($("#modal-faq").modal("show"),isIE6||isIE7||isIE8){var val=$(this).attr("href"),index=val.indexOf("#"),modian=val.substring(index+1),obj=$("iframe").get(0).contentWindow.document.body,pa=$(obj).find(".itemList h1"),hashIndex=util.getUnitAllHeight(pa),html=$("iframe").get(0).contentWindow.document.documentElement;pa.each(function(i){var val=$(this).find("a").attr("name");val===modian&&$(html).scrollTop(hashIndex[i])})}return!1})}},XIAOMI.namespace("goodsComment"),XIAOMI.goodsComment={commentUrl:"http://comment.www./comment/",gid:null,pageSize:8,pageIndex:1,grade:0,orderBy:0,commentTotal:null,pageTotal:null,init:function(){var _this=this;_this.gid=goodsConfig.GoodsId,_this.commentTotal=goodsConfig.CommentTotal,_this.getData(_this.gid,_this.pageSize,_this.pageIndex,_this.grade,_this.orderBy,_this.commentTotal),_this.commentUp()},getData:function(gid,pageSize,pageIndex,grade,orderBy,total){var _this=this;$.ajax({type:"GET",url:_this.commentUrl+"clist/goods_id/"+gid+"/pagesize/"+pageSize+"/pageindex/"+pageIndex+"/comment_grade/"+grade+"/orderby/"+orderBy+"/cnum/"+total,dataType:"jsonp",jsonp:"jsonpcallback",success:function(jsonData){var lens=jsonData.data.comments.length-1,totalCount=parseInt(jsonData.data.total_count,0);if(_this.pageTotal=parseFloat(jsonData.data.page_total),totalCount>0&&"object"==typeof jsonData.data.comments&&lens>=0){for(var i=0;lens>i;i+=1){var average_grade=jsonData.data.comments[i].average_grade,starLevel=Math.floor(average_grade/1);starLevel+=average_grade/1%1>.5?"half":"",jsonData.data.comments[i].starLevel=starLevel}var commentData={Comment:jsonData.data.comments};_this.formatData(commentData);var goodLevel=Math.floor(jsonData.data.comments_good_percent);goodLevel>=97?$("#goodsStarLevel").html("<span class='icon-stat icon-stat-5'></span>"):goodLevel>=93?$("#goodsStarLevel").html("<span class='icon-stat icon-stat-4half'></span>"):$("#goodsStarLevel").html("<span class='icon-stat icon-stat-4'></span>")}else $("#goodsStarLevel").hide(),$("#goodsToComment").html("率先评价此商品").siblings().hide(),$("#goodsCommentList").html("<li style='text-align:center;border:none'>暂时没有评价</li>")}})},formatData:function(commentData){var template=doT.template($("#commentTemplate").html());$("#goodsCommentList").html(template(commentData)),this.pageTotal>1&&this.createPages(this.pageIndex)},commentUp:function(){var _this=this,ctime=(new Date).getTime();$(".commentUp").live("click",function(){var cid=$(this).attr("data-cid"),$this=$(this);return $.ajax({type:"POST",url:XIAOMI.GLOBAL_CONFIG.orderSite+"/comment/up/",dataType:"jsonp",jsonp:"jsonpcallback",data:"comment_id="+cid+"&mtime="+ctime+"&goods_id="+_this.gid,success:function(jsonData){var code=parseInt(jsonData.errorno,0);if(0===code)$this.html("有用("+jsonData.data+")");else if(-1===code){var oLogin=new XIAOMI.app.miniLogin;oLogin.autoExec()}else-2===code&&alert(jsonData.desc)}}),!1})},createPages:function(P){var _this=this,pageNum=5,startPage=1,endPage=pageNum,pageIndex=parseInt(P,0),pageStr="",pagePrevStr="<span class='numbers first'>上一页</span>",pagePrev="<a href='#' class='numbers first' data-value='"+(pageIndex-1)+"'>上一页</a>",pageNext="<a href='#' class='numbers last' data-value='"+(pageIndex+1)+"'>下一页</a>",pageNextStr="<span class='numbers last'>下一页</span>",placeholder="<span class='numbers'>...</span>",i=0;for(pageNum>=_this.pageTotal?(endPage=_this.pageTotal,pageStr=pagePrevStr,placeholder=""):pageNext=placeholder+"<a href='#' class='numbers' data-value='"+_this.pageTotal+"'>"+_this.pageTotal+"</a>"+pageNext,1===pageIndex&&(pageStr=pagePrevStr),pageIndex>1&&_this.pageTotal>=pageIndex&&(pageStr=pagePrev,pageIndex>=pageNum?(startPage=pageIndex-2,endPage=pageIndex+2,pageStr=_this.pageTotal>pageNum?pagePrev+"<a href='#' class='numbers' data-value='1'>1</a>"+placeholder:pagePrev,pageIndex>_this.pageTotal-pageNum+1&&(placeholder="",startPage=_this.pageTotal-4,endPage=_this.pageTotal,pageNext="<a href='#' class='numbers last' data-value='"+(pageIndex+1)+"'>下一页</a>",pageIndex===_this.pageTotal&&(pageNext=pageNextStr))):pageIndex===_this.pageTotal&&(pageNext=pageNextStr)),i=startPage;endPage>=i;i+=1)pageStr+=i===pageIndex?"<span class='numbers current' >"+i+"</span>":"<a href='#' class='numbers' data-value='"+i+"'>"+i+"</a>";pageStr+=pageNext,$("#commentPages").show().html(pageStr).find("a.numbers").click(function(){var p=$(this).attr("data-value");return _this.pageIndex=parseInt(p,0),_this.getData(_this.gid,_this.pageSize,_this.pageIndex,_this.grade,_this.orderBy,_this.commentTotal),$("html,body").scrollTop($("#goodsComment").offset().top-60),!1})}},$(function(){XIAOMI.goodsDetail.init(),XIAOMI.goodsComment.init()});