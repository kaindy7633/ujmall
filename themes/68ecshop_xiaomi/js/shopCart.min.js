XIAOMI.namespace("shopCart"),XIAOMI.shopCart={init:function(){var _this=this;_this.addShop(),$(".delGoodsTrigger").bind("click",function(){var goodsId=$(this).attr("id"),msg=$(this).attr("data-msg");return _this.delGoods(goodsId,msg),!1}),$("#clearShopCart").click(function(){var url=$(this).attr("href"),msg=$(this).attr("data-msg");return confirm(msg)&&(window.location.href=url),_gaq.push(["_trackEvent","购物车","A1","清空购物车"]),!1}),$(".changeGoodsNum").find(".goodsNum").blur(function(){var val=parseInt($(this).val(),0);return max=parseInt($(this).attr("data-buylimit"),0),num=parseInt($(this).attr("data-num"),0),(isNum=XIAOMI.lang.isNumber(val))?1>val?($(this).val(num),!1):val>max?(_this.changeGoodsNum(max,"input",$(this).attr("name")),_this.tipFun("该商品数量不能大于"+max),!1):(_this.changeGoodsNum(val,"input",$(this).attr("name")),void 0):(_this.tipFun("输入的数量只能是数字！"),$(this).val(num),!1)}),$(".changeGoodsNum").find(".goodsNumMinus").click(function(){var numObj=$(this).parent().find(".goodsNum"),val=parseInt(numObj.val(),0);return XIAOMI.lang.isNumber(val)?(val>1&&_this.changeGoodsNum(val,"reduce",numObj.attr("name")),!1):(_this.tipFun("输入的数量只能是数字！"),!1)}),$(".changeGoodsNum").find(".goodsNumPlus").click(function(){var numObj=$(this).parent().find(".goodsNum"),val=parseInt(numObj.val(),0),max=parseInt(numObj.attr("data-buylimit"),0);return XIAOMI.lang.isNumber(val)?(val>=1&&max>val?_this.changeGoodsNum(val,"add",numObj.attr("name")):_this.changeGoodsNum(max,"add",numObj.attr("name")),!1):(_this.tipFun("输入的数量只能是数字!"),!1)}),$(".giftSelected").click(function(){var actId=$(this).attr("data-actId");return _this.chooseGoods(!0,actId),!1}),XIAOMI.app.googleAnalytics(["#xmRecommend","#xmCouDan"],{page:"购物车",position:["A1","B1"],url:!0}),$("#shopCartCoudanTrigger").bind("click",function(){return $("#xmCouDanBox").modal("show"),_this.coudan(),_gaq.push(["_trackEvent","购物车","立即凑单","1"]),!1}),$("#shopCartCoudanTrigger").length>0&&_gaq.push(["_trackEvent","购物车","立即凑单","0"])},addShop:function(){var items=$("#addShopList > li"),_this=this;items.each(function(){$(this).bind("click",function(){var cla=$(this).attr("class")||"",isSelected=0>cla.indexOf("selected")?!0:!1,goodsId=$(this).attr("data-goodsid"),itemId=$(this).attr("data-itemid"),isBatch=$(this).attr("data-isbatch"),actId=$(this).attr("data-actId");isSelected?("true"===isBatch?_this.chooseGoods(!1,actId):_this.ajaxAddGoods(goodsId),_gaq.push(["_trackEvent","购物车","C1_"+$(this).index(),goodsId])):_this.ajaxDelGoods(itemId)}),$(this).hover(function(){$(this).children(".pic").stop(!0,!0).fadeIn(200)},function(){$(this).children(".pic").hide()})})},chooseGoods:function(isGift,actId){var _this=this,box=$("#addShopSelectBox"+actId),list=$("#addShopSelectList"+actId),btn=$("#addShopSelectBtn"+actId),input=$("input[name='addShopSelect"+actId+"']"),lens=list.find("li").length,boxW=180*lens+40,docW=document.body.clientWidth;$(window).height(),1200>docW&&lens>5&&(boxW=140*lens+40,list.find("li").width("140px")),void 0===document.getElementById("addShopSelectBox"+actId).style.maxHeight?box.css({width:boxW,"margin-left":-(boxW/2)}).modal("show"):box.css({width:boxW,"margin-left":-(boxW/2),top:"50%","margin-top":"-200px"}).modal("show"),list.find("li").click(function(){$(this).addClass("selected").siblings().removeClass("selected"),$(this).find(input).attr("checked",!0);var gid=$(this).val();btn.attr("href","/cart/add/"+gid).addClass("btn-primary")}),box.find(".close").click(function(){box.modal("hide")}),btn.unbind().bind("click",function(){if($(this).hasClass("btn-primary")){var gid=list.find(".selected").find(input).val();_this.ajaxAddGoods(gid),box.modal("hide")}return!1})},ajaxAddGoods:function(goodsId){var _this=this,url="/cart/add/"+goodsId;$.ajax({type:"POST",url:url,dataType:"json",success:function(data){return 1!==data.code?(_this.tipFun(data.message),!1):(_this.updateShopCart(),void 0)}})},delGoods:function(goodsId,msg){var _this=this;return confirm(msg)?(_this.ajaxDelGoods(goodsId),void 0):!1},ajaxDelGoods:function(goodsId){var _this=this;$.ajax({type:"POST",dataType:"json",url:"/cart/delete/"+goodsId+"?ajax=cart-grid",cache:"false",success:function(data){1===data.deleteBatch&&_this.updateShopCart()}})},changeGoodsNum:function(num,type,name){var _this=this;"add"===type?num+=1:"reduce"===type&&(num-=1),$.ajax({type:"POST",url:"/cart/update",data:name+"="+num,dataType:"text",success:function(d){var data=$.trim(d);if("ok"===data)XIAOMI.app.updateMiniCart();else{if("CANTMODIFY"===data)return _this.tipFun("非常抱歉！该商品不允许修改数量！"),!1;if("SALEOUT"===data)return _this.tipFun("修改失败！"),window.location.reload(),!1;if(data.indexOf("MAX")>-1){var dataItem=data.split("|");return $("#Cart_"+dataItem[1]).val(dataItem[2]),"1"===dataItem[3]?_this.tipFun("每笔订单最多购买4部小米手机。如有需要，请您另下订单继续购买。"):_this.tipFun("超出商品最大购买数量。"),!1}_this.tipFun(data)}_this.updateShopCart()}})},updateShopCart:function(){var _this=this;$.ajax({type:"POST",url:"/cart?ajax=shopCarBox",dataType:"json",success:function(data){data.total>0?($("#shopCartBox").html(data.html),_this.init()):window.location.href="/cart/",XIAOMI.app.updateMiniCart()}})},tipFun:function(msg){alert(msg)},coudan:function(){return XIAOMI.app.Recommend({obj:$("#xmCouDan"),list:$("#xmCouDanList"),autoPlay:!1,speed:5e3,prevBtn:$("#xmCouDanPrev"),nextBtn:$("#xmCouDanNext"),itemW:238}),!1}},$(function(){XIAOMI.shopCart.init(),XIAOMI.app.Recommend()});